#!/usr/bin/env ruby

# Gathers redis INFO statistics and submits them to Riemann.

require File.expand_path('../../lib/riemann/tools', __FILE__)

class Riemann::Tools::Redis
  include Riemann::Tools
  require 'redis'

  opt :redis_host, "Redis hostname", :default => 'localhost'
  opt :redis_port, "Redis port", :default => 6379
  opt :redis_password, "Redis password", :default => ''
  opt :redis_url, "Redis URL", :default => ''
  opt :redis_socket, "Redis socket", :default => ''

  def initialize
    options = if opts[:redis_url] != ''
                { :url => opts[:redis_url] }
              elsif opts[:redis_socket] != ''
                { :path => opts[:redis_socket] }
              else
                { :host => opts[:redis_host], :port => opts[:redis_port] }
              end
    @redis = ::Redis.new(options)
    @redis.auth(opts[:redis_password]) unless opts[:redis_password] == ''
  end

  def tick
    @redis.info.each do |property, value|
      report(
        :host    => opts[:redis_host],
        :service => "redis #{property}",
        :metric  => value.to_f,
        :state   => 'ok',
        :tags    => ['redis']
      )
    end
  end

end

Riemann::Tools::Redis.run
